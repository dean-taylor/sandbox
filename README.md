# Sandbox

This is a development and testing environment utilising the following main components.

* [VirtualBox](https://www.virtualbox.org/wiki/Downloads)
  * VirtualBox Extension Pack
* [Vagrant](https://www.vagrantup.com/docs/installation)
* [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)

## Non-Windows hosts prep.

On non-Windows hosts the assumption has been made that you have your own IDEs, editors, languages, etc..., already installed. To accommodate the VMs take a more passive role.
Once the above components are installed and working there are a small number of operations on your host that are required.
Firstly, Ansible runs are triggered from your host machine, not the primary VM as with Windows based hosts. This requires that the Ansible collectiosn and roles required for the
configuration of VMs need to be loaded onto your host.

```console
ansible-galaxy collection install -r requirements.yml
ansible-galaxy role install -r requirements.yml
```

## Windows host prep.

On Windows based host systems many of the tools for development and provisioning have been moved to a primary VM, this introduces a minimalistic approach for the requirements
on the Windows host to fit a SOE (Standard Operating Environment) Institutional / Corporate preferred model.

On Windows based hosts you will need:
* `VirtualBox` as your hypervisor
* `Vagrant` to configure the standardised complex test systems

## Cheat sheet

From the Sanbox project directory, in the same directory as the `Vagrantfile` file.

```console
# Start a single VM
vagrant up

# Stop and cleanup VMs
vagrant destroy

# Rerun or trigger a provisioning process
vagrant provision

# Log into the VM
vagrant ssh

# Verify status of the VMs
vagrant status

# All the above commands will be run on k8s-0, if you need act on another VM you need to add the machine name.
vagrant up k8s-1
vagrant ssh k8s-1
vagrant destroy k8s-1
```

## Stuff to know

Ensure that you have the core components installed. This template also expects a number of common work practices.

With Windows machines and the common practice to lock down a Institutional or Corporate provided laptops the host has minimal required alterations.
Every tool other than the ones listed will be installed and run from the primary VM `k8s-0`.

For every other OS it is assumed that you develop utilising your host and only require this framework for testing.
This would include the Ansible client, ssh, git, gpg, SOPS, ...

## Core requirements:

* Platform agnostic
  Supports Linux, Mac and Windows.
* Shareable
  All project team members should be able to use this resource to aid in collaboration.
* Generic as possible
  All Ansible provisioning can be triggerd via the standard `vagrant provision` command.
* Minimise setup tasks
  Although there are many Vagrant plugins to make things work these have been avoided to reduce dependencies.

## Stuff that makes this work.

* Folder share `/vagrant` to the base project directory is essential as many setup scripts require access to the .vagrant folder on the host.
* Multicast DNS configured for the private network to provide name and IP resolution.
  * The `.local` mDNS standard name has been added to the DNS client search path.
* SSH access to individual nodes.
  * There are a number of scripts in play depending on provisioning type and access.
  * From the host the usual `vagrant ssh` command is still utilised.
  * From one host to another using an active session the `ssh-agent` has been configured and the Vagrant generated private keys have been automatically loaded.
  * On Windows using Vagrants ansible_local provisioner (no interactive session).
    * A global SSH client configuration file has been generated for all the Vagrant machines.
    * Entries for the Vagrant users ssh_config have been added to utilise individual private key files generated by Vagrant
    * The Vagrant generated SSH private key files have been synced to the vagrant users home folder and mandated file permissions have been applied for the ssh client.

## MetalLB setup

Reserve an IPv4 address block within the DHCP server configuration. Replace the DHCP network name and IPv4 subnet values for your specific system.

```console
PS> vboxmanage list dhcpservers
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f0 --fixed-address=172.28.128.240
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f1 --fixed-address=172.28.128.241
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f2 --fixed-address=172.28.128.242
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f3 --fixed-address=172.28.128.243
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f4 --fixed-address=172.28.128.244
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f5 --fixed-address=172.28.128.245
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f6 --fixed-address=172.28.128.246
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f7 --fixed-address=172.28.128.247
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f8 --fixed-address=172.28.128.248
PS> vboxmanage dhcpserver modify --network="HostInterfaceNetworking-VirtualBox Host-Only Ethernet Adapter #2" --mac-address=ff:ff:ff:ff:ff:f9 --fixed-address=172.28.128.249
```

Enable the MetalLB Microk8s plugin configuring the IPv4 range reserved above.

```console
kubectl enable metallb:172.28.128.240-172.28.128.249
```

# Misc. stuff

```console
PS C:\Users\00078081\sandbox> vboxmanage list vms
"sandbox_k8s-0_1621381899680_92904" {59d0404a-cf5e-42dd-aac5-38135a997ea6}
"sandbox_k8s-1_1621569054819_21712" {a9d01ccb-6164-47b9-9fd0-69161bd39351}
"sandbox_k8s-2_1621569146247_91804" {15baf9a0-504b-4d66-8573-0a7af8e12f6e}
"sandbox_docker-swarm-0_1621896947507_69748" {27ccae4f-81d0-4957-af46-0708537ac8bc}
"sandbox_docker-swarm-1_1621899889042_41493" {bfd7a2f4-e149-4906-bb78-c99c02cf345f}
"sandbox_docker-swarm-2_1621900008356_68353" {4f845c5a-a261-44eb-bda6-01734c411fcd}
PS C:\Users\00078081\sandbox> vboxmanage startvm sandbox_k8s-1_1621569054819_21712 --type headless
Waiting for VM "sandbox_k8s-1_1621569054819_21712" to power on...
VM "sandbox_k8s-1_1621569054819_21712" has been successfully started.
PS C:\Users\00078081\sandbox> vboxmanage startvm sandbox_k8s-2_1621569146247_91804 --type headless
Waiting for VM "sandbox_k8s-2_1621569146247_91804" to power on...
VM "sandbox_k8s-2_1621569146247_91804" has been successfully started.
```
